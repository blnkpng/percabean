<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Form Pengeluaran - Minang Chicken</title>

  <!-- ===== CSS STYLING KHUSUS IOS DESIGN ===== -->
  <style>
    /* WARNA UTAMA DAN STANDAR VISUAL */
    :root {
      --primary: #007aff;               /* Biru iOS khas */
      --background: #f2f2f7;            /* Background lembut */
      --surface: #ffffff;               /* Putih bersih */
      --text-primary: #1c1c1e;          /* Warna teks utama */
      --border-color: #d1d1d6;          /* Warna border soft */
      --success: #34c759;               /* Warna sukses ala iOS */
      --radius: 12px;                   /* Radius umum */
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0;
      padding: 16px;
      background-color: var(--background);
      color: var(--text-primary);
    }

    /* WRAPPER KONTEN UTAMA */
    .container {
      max-width: 720px;
      margin: 0 auto;
      background-color: var(--surface);
      border-radius: var(--radius);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      padding: 24px;
    }

    /* JUDUL FORM */
    h2 {
      text-align: center;
      margin-bottom: 24px;
    }

    /* GRUP INPUT */
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 16px;
    }

    label {
      font-weight: 500;
      font-size: 15px;
    }

    input, select {
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      font-size: 16px;
      background-color: #fefefe;
      width: 100%;
    }

    input.readonly {
      background-color: #f0f0f5;
    }

    /* GRUP TOMBOL */
    .button-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    button {
      flex: 1;
      padding: 12px;
      font-size: 16px;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      transition: background-color 0.2s;
    }

    button:hover {
      background-color: #005fcb;
    }

    /* WRAPPER TABEL AGAR RESPONSIF */
    .table-wrapper {
      overflow-x: auto;
      margin-top: 32px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 700px;
    }

    th, td {
      padding: 10px 12px;
      text-align: left;
      font-size: 14px;
      border-bottom: 1px solid var(--border-color);
    }

    th {
      background-color: #f7f7f7;
    }

    /* TOAST NOTIFIKASI GAYA IOS */
    #toast {
      visibility: hidden;
      min-width: 250px;
      background-color: var(--success);
      color: white;
      text-align: center;
      border-radius: var(--radius);
      padding: 12px 20px;
      position: fixed;
      z-index: 999;
      left: 50%;
      bottom: 30px;
      transform: translateX(-50%);
      font-size: 16px;
      opacity: 0;
      transition: opacity 0.4s ease-in-out, visibility 0.4s;
    }

    #toast.show {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>
<body>

  <!-- ========== FORM INPUT DATA ========== -->
  <div class="container">
    <h2>Form Pengeluaran</h2>
    <form id="pengeluaranForm">

      <!-- Input Tanggal -->
      <div class="form-group">
        <label>Tanggal</label>
        <input type="date" id="tanggal" required>
      </div>

      <!-- Dropdown Nama Barang -->
      <div class="form-group">
        <label>Nama Barang</label>
        <select id="namaBarang" required onchange="updateAutoFields()">
          <option value="">-- Pilih Barang --</option>
        </select>
      </div>

      <!-- Input Quantity -->
      <div class="form-group">
        <label>Qty</label>
        <input type="number" id="qty" required oninput="updateTotal()">
      </div>

      <!-- Input Satuan (Otomatis) -->
      <div class="form-group">
        <label>Satuan</label>
        <input type="text" id="satuan" class="readonly" readonly>
      </div>

      <!-- Input Laba Manual -->
      <div class="form-group">
        <label>Harga Laba (Rp)</label>
        <input type="number" id="laba" required oninput="updateTotal()">
      </div>

      <!-- Harga Jual Otomatis -->
      <div class="form-group">
        <label>Harga Jual (Rp)</label>
        <input type="number" id="hargaJual" class="readonly" readonly>
      </div>

      <!-- Total Harga Otomatis -->
      <div class="form-group">
        <label>Total Harga (Rp)</label>
        <input type="text" id="totalHarga" class="readonly" readonly>
      </div>

      <!-- Tombol Aksi -->
      <div class="button-group">
        <button type="button" onclick="tambahKeDaftar()">+ Tambah ke Daftar</button>
        <button type="button" onclick="kirimSemua()">Kirim Semua</button>
      </div>
    </form>
  </div>

  <!-- ========== TABEL DATA ========== -->
  <div class="container table-wrapper">
    <h3>Daftar Terkumpul</h3>
    <table id="dataTable">
      <thead>
        <tr>
          <th>Tanggal</th>
          <th>Barang</th>
          <th>Qty</th>
          <th>Satuan</th>
          <th>Laba</th>
          <th>Jual</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- ========== TOAST NOTIFIKASI ========== -->
  <div id="toast"></div>

  <!-- ========== SCRIPT LOGIKA FORM ========== -->
<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbwwnK8TXS84DVnOoSNfZeeTA212LxJYwVkp541YSbYAgo-bEeoNDCzOIvutJYlhkIBx6g/exec";

  let listBahan = {};  // data dari server
  const dataTerkumpul = [];

  function showToast(message) {
    const toast = document.getElementById("toast");
    toast.textContent = message;
    toast.className = "show";
    setTimeout(() => toast.className = "", 3000);
  }

  async function populateDropdown() {
    try {
      const res = await fetch(API_URL);
      const data = await res.json();

      const dropdown = document.getElementById("namaBarang");
      dropdown.innerHTML = `<option value="">-- Pilih Barang --</option>`;

      data.forEach(item => {
        const nama = item.name || item.nama; // fallback
        const satuan = item.satuan;
        const hargaJual = parseFloat(item.hargaJual || item.price || 0);
        const qty = parseFloat(item.qty || 0);

        const option = new Option(nama, nama);
        dropdown.add(option);

        listBahan[nama] = { satuan, hargaJual, qty };
      });
    } catch (err) {
      console.error("Fetch error:", err);
      showToast("❌ Gagal ambil data");
    }
  }

  function updateAutoFields() {
    const barang = document.getElementById("namaBarang").value;
    if (barang && listBahan[barang]) {
      document.getElementById("satuan").value = listBahan[barang].satuan;
      document.getElementById("hargaJual").value = listBahan[barang].hargaJual;
      updateTotal();
    } else {
      document.getElementById("satuan").value = "";
      document.getElementById("hargaJual").value = "";
      document.getElementById("totalHarga").value = "";
    }
  }

  function updateTotal() {
    const qty = parseFloat(document.getElementById("qty").value) || 0;
    const laba = parseFloat(document.getElementById("laba").value) || 0;
    const hargaJual = parseFloat(document.getElementById("hargaJual").value) || 0;
    const total = qty * (hargaJual + laba);
    document.getElementById("totalHarga").value = "Rp " + total.toLocaleString('id-ID');
  }

  function tambahKeDaftar() {
    const data = {
      tanggal: document.getElementById("tanggal").value,
      namaBarang: document.getElementById("namaBarang").value,
      qty: document.getElementById("qty").value,
      satuan: document.getElementById("satuan").value,
      laba: document.getElementById("laba").value,
      hargaJual: document.getElementById("hargaJual").value,
      total: document.getElementById("totalHarga").value
    };
    if (!data.namaBarang || !data.qty || !data.laba) {
      showToast("Lengkapi semua field");
      return;
    }
    dataTerkumpul.push(data);
    renderTable();
    document.getElementById("pengeluaranForm").reset();
    document.getElementById("tanggal").valueAsDate = new Date();
    showToast("Ditambahkan ✅");
  }

  function renderTable() {
    const tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML = "";
    dataTerkumpul.forEach(item => {
      const row = [
        item.tanggal,
        item.namaBarang,
        item.qty,
        item.satuan,
        `Rp ${parseInt(item.laba).toLocaleString('id-ID')}`,
        `Rp ${parseInt(item.hargaJual).toLocaleString('id-ID')}`,
        item.total
      ].map(v => `<td>${v}</td>`).join("");
      tbody.innerHTML += `<tr>${row}</tr>`;
    });
  }

async function kirimSemua() {
  if (!dataTerkumpul.length) {
    showToast("Belum ada data");
    return;
  }

  try {
    const res = await fetch(API_URL + "?action=kirimDataOutput", {
  method: "POST",
  headers: { "Content-Type": "text/plain" },
  body: JSON.stringify(dataTerkumpul)
});

    const text = await res.text();
    console.log("Respon dari server:", text);
    showToast("Terkirim 🚀");
    dataTerkumpul.length = 0;
    renderTable();
  } catch (err) {
    console.error("❌ Fetch Error:", err);
    showToast("Gagal kirim! " + err.message);
  }
}
  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("tanggal").valueAsDate = new Date();
    populateDropdown();
  });
</script>
</body>
</html>
