<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Input Barang Keluar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
:root {
  --bg-light: #ffffff;
  --bg-dark: #121212;
  --grid-light: #dddddd;
  --grid-dark: #222222;
  --text-light: #000000;
  --text-dark: #eeeeee;
  --input-bg-light: #ffffff;
  --input-bg-dark: #222222;
  --input-border-light: #000000;
  --input-border-dark: #eeeeee;
  --button-light-bg: #000000;
  --button-dark-bg: #eeeeee;
  --button-light-text: #ffffff;
  --button-dark-text: #000000;
  --popup-bg-light: #ffffff;
  --popup-bg-dark: #2a2a2a;
  --subtitle-light: #666;
  --subtitle-dark: #bbb;
}

body {
  margin: 0;
  font-family: 'Montserrat', sans-serif;
  background-color: var(--bg-light);
  background-image: linear-gradient(to right, var(--grid-light) 1px, transparent 1px),
                    linear-gradient(to bottom, var(--grid-light) 1px, transparent 1px);
  background-size: 30px 30px;
  color: var(--text-light);
  transition: background-color 0.5s ease, color 0.5s ease;
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  position: relative;
}

body.dark {
  background-color: var(--bg-dark);
  background-image: linear-gradient(to right, var(--grid-dark) 1px, transparent 1px),
                    linear-gradient(to bottom, var(--grid-dark) 1px, transparent 1px);
  color: var(--text-dark);
}

.subtitle {
  text-align: center;
  font-weight: 400;
  margin: 1rem 0;
  font-size: 14px;
  color: var(--subtitle-light);
margin-top : 0px;
}

body.dark .subtitle {
  color: var(--subtitle-dark);
}

.container {
  background: var(--bg-light);
  color: var(--text-light);
  padding: 2rem;
  border-radius: 16px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  max-width: 600px;
  width: 100%;
  transition: 0.5s ease;
}

body.dark .container {
  background: #1e1e1e;
  color: var(--text-dark);
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
}

form {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
}

.form-group {
  flex: 1 1 38%;
  display: flex;
  flex-direction: column;

}
.form-group.full {
  flex: 1 1 100%;
}

label {
  font-weight: 400;
  margin-bottom: 10px;
text-align : center;
}

input, select, textarea {
  font-family: 'Montserrat';
  padding: 0.6rem;
  font-size: 16px;
  border-radius: 20px;
  border: 2px solid var(--input-border-light);
  background: var(--input-bg-light);
  color: var(--text-light);
  text-align: center;
  transition: 0.3s;
}

body.dark input,
body.dark select,
body.dark textarea {
  background: var(--input-bg-dark);
  color: var(--text-dark);
  border-color: var(--input-border-dark);
}

input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: #ffa500;
  box-shadow: 0 0 5px #ffa500aa;
}

.button, #loginBtn {
  margin-top: 1rem;
  padding: 0.7rem 1.5rem;
  font-weight: bold;
  border: none;
  border-radius: 100px;
  background-color: var(--button-light-bg);
  color: var(--button-light-text);
  cursor: pointer;
  transition: 0.3s;
}

body.dark .button, body.dark #loginBtn {
  background-color: var(--button-dark-bg);
  color: var(--button-dark-text);
}

.button:hover, #loginBtn:hover {
  opacity: 0.9;
}

.toggle-mode {
  position: absolute;
  top: 1rem;
  right: 1rem;
  cursor: pointer;
  background: transparent;
  border: none;
  font-weight: bold;
  font-family: inherit;
  color: inherit;
}

.header-img {
  display: block;
  margin: 0 auto 1rem;
  width: 340px;
  max-width: 50%;
  border-radius: 25px;
  transition: filter 0.5s ease;
  user-select: none;
}
body.dark .header img:hover {
  filter: drop-shadow(0 0 10px #ffa500);
  cursor: pointer; /* opsional, biar mouse berubah jadi pointer */
}
.popup {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.6);
  justify-content: center;
  align-items: center;
  z-index: 999;
}

.popup-content {
  background: var(--popup-bg-light);
  padding: 2rem;
  border-radius: 16px;
  max-width: 400px;
  width: 90%;
  text-align: center;
  color: var(--text-light);
}

body.dark .popup-content {
  background: var(--popup-bg-dark);
  color: var(--text-dark);
}

.popup-buttons {
  margin-top: 1.5rem;
  display: flex;
  justify-content: space-around;
}

.popup-buttons button {
  padding: 0.5rem 1.2rem;
  border-radius: 8px;
  border: none;
  font-weight: bold;
  cursor: pointer;
}

.popup-buttons .send {
  background: #28a745;
  color: white;
}

.popup-buttons .cancel {
  background: #dc3545;
  color: white;
}

@media (max-width: 600px) {
  .form-group {
    flex: 1 1 100%;
  }
}
.button-wrapper {
  display: flex;
  justify-content: center;
  gap: 15px; /* jarak antar tombol */
  flex-wrap: nowrap; /* jangan sampai tombol pindah baris */
  align-items: center; /* vertical center */
  padding: 0 10px;
}
    /* Button */
    .animated-button {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
       padding: 0.6rem;
     border: 4px solid transparent;
      font-family: 'Montserrat';
      font-size: 16px;
      background-color: #fff;
      border-radius: 100px;
      font-weight: 800;
      color: #000;
      box-shadow: 0 0 0 2px #000;
      cursor: pointer;
      overflow: hidden;
      transition:
      background-color 0.5s ease,
      color 0.5s ease,
      box-shadow 0.5s ease;
      user-select: none;
      min-width: 180px;
      margin: 0 auto;
    }
    body.dark .animated-button {
      background-color: #121212;
      color: #eee;
      box-shadow: 0 0 0 2px #eee;
    }

    .animated-button .circle {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 20px;
      height: 15px;
      background-color: #da0000;
      border-radius: 50%;
      opacity: 0;
      transition: all 0.8s cubic-bezier(0.23, 1, 0.32, 1);
      pointer-events: none;
    }
    body.dark .animated-button .circle {
      background-color: #da0000;
    }

    .animated-button .text {
      position: relative;
      z-index: 1;
      transition: all 0.8s cubic-bezier(0.23, 1, 0.32, 1);
      user-select: none;
      
    }

    .animated-button:hover {
      box-shadow: 0 0 0 12px transparent;
      color: #fff;
      background-color: #da0000;
      border-radius: 12px;
    }
    body.dark .animated-button:hover {
      background-color: #da0000;
      color: #fff;
      box-shadow: 0 0 0 12px transparent;
      border-radius: 12px;
    }

    .animated-button:active {
      scale: 0.95;
      box-shadow: 0 0 0 4px #000;
    }
    body.dark .animated-button:active {
      box-shadow: 0 0 0 4px #eee;
    }

    .animated-button:hover .circle {
      width: 220px;
      height: 220px;
      opacity: 1;
    }
    /* Menu Utama */
.menu-btn:hover {
  background-color: #187498;
  color: #fff;
}
body.dark .menu-btn:hover {
  background-color: #187498;
  color: #fff;
}
.menu-btn .circle {
  background-color: #187498;
}
body.dark .menu-btn .circle {
  background-color: #187498;
}

/* Kirim */
.kirim-btn:hover {
  background-color: #16610E;
  color: #fff;
}
body.dark .kirim-btn:hover {
  background-color: #16610E;
  color: #fff;
}
.kirim-btn .circle {
  background-color: #16610E;
}
body.dark .kirim-btn .circle {
  background-color: #16610E;
}

/* Logout */
.logout-btn:hover {
  background-color: #CB0404;
  color: #fff;
}
body.dark .logout-btn:hover {
  background-color: #CB0404;
  color: #fff;
}
.logout-btn .circle {
  background-color: #CB0404;
}
body.dark .logout-btn .circle {
  background-color: #CB0404;
}

@media (max-width: 768px) {
  .button-wrapper {
    gap: 8px;
    padding: 5px;
  }

  .animated-button {
    flex: 1; /* tombol berbagi ruang sama rata */
    max-width: 120px; /* batas maksimal lebar tombol */
    height: 80px; /* tinggi tetap */
    font-size: 0.8rem; /* ukuran font tetap */
    padding: 0;
    min-width: 120px; /* hilangkan min-width agar bisa mengecil */
  }
}

@media (max-width: 480px) {
  .animated-button {
    max-width: 100px;
    height: 36px;
    font-size: 0.75rem;
  }
}

    /* Copyright */
    .copyright {
      margin-top: 2rem;
      font-size: 0.9rem;
      color: #888;
      user-select: none;
      transition: color 0.5s ease;
      text-align : center;
    }
    body.dark .copyright {
      color: #666;
    }
    input::placeholder {
      color: #666;
      user-select: none;
      font-size : 16px;
    }
    body.dark input::placeholder {
      color: #aaa;
    } 
    input:invalid {
    border-color: #f87171;
    }
    input:focus {
    outline: none;
    ring: 2px solid #60a5fa;
    transition: all 0.2s ease-in-out;
    }
    input:invalid {
    border-color: #f87171;
    }
    button[disabled] {
    opacity: 0.6;
    cursor: not-allowed;
    }
    /* Stok Info Box */
.stok-info {
  display: none;
  margin-top: 2px;
  text-align: center;
  font-size: 15px;
  font-weight: 500;
  color: #1a202c;
  transition: color 0.3s ease;
}

body.dark .stok-info {
  color: #e2e8f0;
}


  </style>
</head>
<body>
  <button class="toggle-mode" onclick="document.body.classList.toggle('dark')">🌓</button>
  <div class="container">
    <h2 style="text-align:center; margin-bottom: 0;">Form Barang Keluar</h2>
    <p class="subtitle">Isi data barang yang akan keluar</p>
    <form id="barangForm">
  <div class="form-group full">
    <label for="tanggal"></label>
    <input type="date" id="tanggal" required>
  </div>

  <div class="form-group half">
    <label for="namaBarang"></label>
    <select id="namaBarang" required placeholder="-- Pilih Nama Barang --"></select>
  </div>

  <div class="form-group half">
    <label for="qty"></label>
    <input type="number" id="qty" required min="1" placeholder="Qty">
    <div id="stokInfo" class="stok-info"></div>
  </div>

  <div class="form-group half">
    <label for="satuan"></label>
    <input type="text" id="satuan" readonly placeholder="Satuan">
  </div>

  <div class="form-group half">
    <label for="harga"></label>
    <input type="text" id="harga" readonly placeholder="Harga Jual">
  </div>

  <div class="form-group half">
    <label for="laba"></label>
    <input type="text" id="laba" required placeholder="Masukan Laba">
  </div>

  <div class="form-group half">
    <label for="totalHarga"></label>
    <input type="text" id="totalHarga" readonly placeholder="Rp0">
  </div>

  <div class="form-group full" style="text-align: center;">
    <button type="submit" class="animated-button kirim-btn">
      <span class="circle"></span>
      <span class="text">Kirim</span>
    </button>
  </div>
</form>
    <p class="copyright">&copy; Percabean | 2025</p>
  </div>

<script>
  // Ambil elemen DOM
  const namaBarangSelect = document.getElementById('namaBarang');
  const satuanInput = document.getElementById('satuan');
  const hargaInput = document.getElementById('harga');
  const stokInfo = document.getElementById('stokInfo');
  const qtyInput = document.getElementById('qty');
  const totalHargaInput = document.getElementById('totalHarga');
  const labaInput = document.getElementById('laba');
  const form = document.getElementById('barangForm');
  const submitBtn = form.querySelector('button[type="submit"]');
  const tanggalInput = document.getElementById("tanggal");

  let barangList = [];
  let isSubmitting = false; // 🔒 Prevent ganda submit

  // Set tanggal otomatis ke hari ini
  tanggalInput.valueAsDate = new Date();

  // Format angka ke Rupiah
  function formatRupiah(angka) {
    return 'Rp' + angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }

  // Update total harga
  function updateTotalHarga() {
    const selected = barangList.find(b => b.namaBarang === namaBarangSelect.value);
    const qty = parseInt(qtyInput.value);
    const laba = parseInt(labaInput.value.replace(/[^\d]/g, '')) || 0;

    if (selected && !isNaN(qty)) {
      const total = (selected.harga + laba) * qty;
      totalHargaInput.value = formatRupiah(total);
    } else {
      totalHargaInput.value = '';
    }
  }

  // Ambil data barang dari Apps Script
  fetch("https://script.google.com/macros/s/AKfycbwtjXiwx9bLxUrFdGhqxqQ8PVuw7kWL5dj3nvXVRjROr8fVGFe5Qz3HLscJd97w3AUqiQ/exec?action=getBahanData")
    .then(res => res.json())
    .then(data => {
      if (!Array.isArray(data)) throw new Error("Data bukan array");
      barangList = data;

      // Tambah opsi default
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.disabled = true;
      defaultOption.selected = true;
      defaultOption.hidden = true;
      defaultOption.textContent = '-- Pilih Barang --';
      namaBarangSelect.appendChild(defaultOption);

      // Isi pilihan barang
      barangList.forEach(item => {
        const option = document.createElement('option');
        option.value = item.namaBarang;
        option.textContent = item.namaBarang;
        namaBarangSelect.appendChild(option);
      });
    })
    .catch(err => {
      console.error("Gagal ambil data barang:", err);
      alert("Gagal memuat data barang!");
    });

  // Saat barang dipilih
  namaBarangSelect.addEventListener('change', () => {
    const selected = barangList.find(b => b.namaBarang === namaBarangSelect.value);
    if (selected) {
      satuanInput.value = selected.satuan;
      hargaInput.value = formatRupiah(selected.harga);
      stokInfo.textContent = `Stok tersedia: ${selected.qty} ${selected.satuan}`;
      stokInfo.style.display = 'block';
      qtyInput.max = selected.qty;
      updateTotalHarga();
    } else {
      stokInfo.style.display = 'none';
    }
  });

  // Saat qty berubah
  qtyInput.addEventListener('input', updateTotalHarga);

  // Saat laba diketik
  labaInput.addEventListener('input', () => {
    let raw = labaInput.value.replace(/[^\d]/g, '');

    // 🔧 Cegah kursor loncat
    let start = labaInput.selectionStart;
    labaInput.value = formatRupiah(raw);
    labaInput.setSelectionRange(start + 3, start + 3); // Rp = 2 huruf + 1 spasi
    updateTotalHarga();
  });

  // Fungsi loading state
  function setLoadingState(loading) {
    submitBtn.disabled = loading;
    submitBtn.textContent = loading ? "Mengirim..." : "Kirim";
  }

  // Mark error field
  function markInvalid(input) {
    input.classList.add("border-red-500", "ring-red-300", "ring-2");
  }

  // Clear error
  function clearInvalid(input) {
    input.classList.remove("border-red-500", "ring-red-300", "ring-2");
  }

  // Submit form
  form.addEventListener('submit', (e) => {
    e.preventDefault();

    if (isSubmitting) return; // 🔐 Prevent ganda
    isSubmitting = true;
    setLoadingState(true);

    const selected = barangList.find(b => b.namaBarang === namaBarangSelect.value);
    const qty = parseInt(qtyInput.value);
    const labaRaw = labaInput.value.replace(/[^\d]/g, '');

    // Validasi
    let isValid = true;
    clearInvalid(tanggalInput);
    clearInvalid(qtyInput);
    clearInvalid(labaInput);

    if (!tanggalInput.value) {
      markInvalid(tanggalInput);
      isValid = false;
    }

    if (!qty || qty <= 0 || isNaN(qty)) {
      markInvalid(qtyInput);
      isValid = false;
    }

    if (!labaRaw || isNaN(parseInt(labaRaw))) {
      markInvalid(labaInput);
      isValid = false;
    }

    if (!selected) {
      alert("Barang belum dipilih.");
      isValid = false;
    }

    if (qty > selected?.qty) {
      alert("Jumlah melebihi stok tersedia!");
      markInvalid(qtyInput);
      isValid = false;
    }

    if (!isValid) {
      setLoadingState(false);
      isSubmitting = false;
      return;
    }

    const data = {
      tanggal: tanggalInput.value,
      namaBarang: selected.namaBarang,
      qty: qty,
      satuan: selected.satuan,
      harga: selected.harga,
      laba: parseInt(labaRaw)
    };

    // Kirim ke Apps Script
    fetch("https://script.google.com/macros/s/AKfycbwtjXiwx9bLxUrFdGhqxqQ8PVuw7kWL5dj3nvXVRjROr8fVGFe5Qz3HLscJd97w3AUqiQ/exec?action=kirimDataOutput", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(data)
    })
      .then(async response => {
        if (!response.ok) throw new Error("Gagal mengirim data");

        const contentType = response.headers.get("Content-Type");
        if (contentType && contentType.includes("application/json")) {
          return await response.json();
        } else {
          return await response.text();
        }
      })
      .then(() => {
        // ✅ Berhasil
        Swal.fire({
          icon: 'success',
          title: 'Berhasil!',
          text: 'Data barang keluar berhasil disimpan.',
          background: document.body.classList.contains("dark") ? "#2a2a2a" : "#ffffff",
          color: document.body.classList.contains("dark") ? "#eeeeee" : "#000000",
          confirmButtonColor: '#28a745'
        }).then(() => {
          setTimeout(() => location.reload(), 400); // ⏳ delay biar UX enak
        });
      })
      .catch(err => {
        // ❌ Gagal
        Swal.fire({
          icon: 'error',
          title: 'Gagal!',
          text: 'Terjadi kesalahan saat mengirim data. Silakan coba lagi.',
          background: document.body.classList.contains("dark") ? "#2a2a2a" : "#ffffff",
          color: document.body.classList.contains("dark") ? "#eeeeee" : "#000000",
          confirmButtonColor: '#dc3545'
        });
        console.error("Error:", err);
      })
      .finally(() => {
        setLoadingState(false);
        isSubmitting = false;
      });
  });
</script>

<!-- Confetti tetap bisa aktif -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</body>
</html>
